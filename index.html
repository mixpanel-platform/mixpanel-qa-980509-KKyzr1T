<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="console">
      <div id="#datepicker"></div>
      <div id="filters"></div>
    </div>
    <table id="table" class="display" width="100%"></table>
    <script id='query'>
      /*
      var params = {
        'from_date': '2016-05-02',
        'to_date': '2016-06-18',
        'filters' : [
          //{property: 'mp_country_code', value: 'TW'}
        ]
      }
      TODO:
      VIZ
      Test filters:
      Filter Priority:
      Date (high priority)
      Country (low priority)
      Region (low priority)
      Product (property: product) (low priority)
      Product language (property: product_language) (low priority)
      */
      
      
      var infinity = function(number){
        var result = number
        if (number == Infinity || number === null || number !== number){
          result = 0
        }
        return result
      }
      
      var filters = function(event){
        return _.every(params.filters, function(filter){
          return filter.value === event.properties[filter.property]
        }) 
      }
      
      function main() {
        return Events({
          from_date: params.from_date,
          to_date:   params.to_date,
          event_selectors: [{event: 'downloaded'}, {event: 'purchase'}, {event: 'installed'}]
        })
        .groupByUser(function(state, items){
          state = state || {};
          _.each(items, function(item){
            if (filters(item)) {
              state[item.properties['x-at']] = state[item.properties['x-at']] || {
                downloaded: 0,
                installed: 0,
                revenue: 0,
                orders: 0,
              }
              switch (item.name){
                case 'purchase':
                  state[item.properties['x-at']]['revenue'] +=  item.properties.amount || 0;
                  state[item.properties['x-at']]['orders'] ++;
                  break;
                case 'downloaded':
                  state[item.properties['x-at']]['downloaded']+=1;
                  break;
                case 'installed':
                  state[item.properties['x-at']]['installed']+=1;
                  break;
                default:
                  break;
              }
            }
          })
          return state
        })
        .map(item => item.value)
        .reduce(mixpanel.reducer.object_merge())
        .map(function(item){
          var result = {}
          _.each(item, function(props, key){
            result[key] = result[key] || { 
                downloaded: 0,
                installed: 0,
                revenue: 0,
                orders: 0,
            }
            _.each(props, function(val, prop){
              result[key][prop] = val;
            })
            result[key]['conversion'] = String(infinity(result[key]['installed'] / result[key]['downloaded'] * 100).toFixed(1)) + "%"
            result[key]['aov'] = String(infinity(result[key]['revenue'] / result[key]['orders']).toFixed(2))
            result[key]['cr'] = String(infinity(result[key]['orders'] / result[key]['installed'] * 100).toFixed(1)) + "%"
            result[key]['trial'] = String(infinity(result[key]['cr'] * result[key]['aov']* 100).toFixed(1)) + "%"
          })
          return result
        })
      }
    </script>
    <script>
    $('#datePicker').MPDatepicker().on('change', function(event, dateRange) { 
      runQuery()
    });
      var table = $('#table').DataTable( {
           paging: false,
           searching: false,
            columns: [
                { title: "x-At" , data: 'x-at' },
                { title: "Downloaded", data: 'downloaded' },
                { title: "Installed", data: 'installed' },
                { title: "Conversion", data: 'conversion' },
                { title: "AOV", data: "aov" },
                { title: "CR", data: "cr" },
                { title: "Trial", data: "trial" }
              ]
        });
    var runQuery = function(){  
      dates = $('#datepicker').MPDatepicker().val
      var params = {
        'from_date': dates.from,
        'to_date': dates.to,
        'filters' : [
          //{property: 'mp_country_code', value: 'TW'}
        ]
      }
      var query = $('#query').html()
      MP.api.jql(query, params).done(function(res){
     
          var table = $('#table').DataTable().clear()
          _.each(res[0], function(vals, prod){
            var row = _.extend({'x-at': prod}, vals)
            table.row.add(row)
          })
         table.draw();
      })
    }
    
    runQuery()
    </script>
  </body>
</html>
